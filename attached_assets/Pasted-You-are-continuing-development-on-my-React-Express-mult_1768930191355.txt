You are continuing development on my React + Express multi-tenant app (single codebase) deployed on Railway.
FEATURE SET: Password reset + Super Admin user provisioning + Tenant lifecycle controls (activate/suspend/archive/delete)
PLUS BUG FIX: Super Admin-generated invite links do not work in incognito; they redirect to login and never show
the invite acceptance / password setup flow. Fix this.

Optimize for Railway and cookie-based auth. Preserve existing behavior where possible.

IMPORTANT SECURITY NOTE:
We will NOT implement “password reset with no verification at all.”
Instead, we will implement:
A) Standard Forgot Password (reset token + link) with email optional
B) Super Admin can generate/copy a reset link for a tenant user (no email required)
C) Super Admin can optionally set a temporary password with “mustChangePasswordOnNextLogin=true”
No passwords are ever emailed.

===============================================================================
ABSOLUTE NON-NEGOTIABLE SAFETY RULES
===============================================================================
- Do NOT change existing endpoint paths or response shapes (add-only endpoints allowed).
- Do NOT weaken tenancy/auth/agreement enforcement.
- Do NOT log secrets, tokens, or passwords.
- Do NOT store raw passwords; hash server-side (bcrypt/argon2).
- No destructive DB changes. Additive schema only if required.
- All admin actions must require confirmation + audit log entry.
- Ensure cookies + proxy trust are correct for Railway.

===============================================================================
PART 0 — BUG: INVITE LINKS FAIL IN INCOGNITO (DIAGNOSE + FIX)
===============================================================================
Symptoms:
- Invite link generated by Super Admin, opened in incognito, redirects to /login
- User never sees “Accept invite / set password / join tenant” screen.

Goal:
- Invite link should open an invite acceptance page that:
  - validates token
  - shows tenant + role + email (masked)
  - allows user to set password (if needed)
  - completes onboarding and logs user in (cookie session), then routes into tenant experience.
- Must work in incognito with zero prior cookies.

Diagnosis steps (required):
1) Identify invite acceptance URL format currently generated:
- e.g. /auth/invite?token=XYZ  OR /invite/XYZ
2) Identify backend endpoint used to validate/accept the invite:
- e.g. POST /api/v1/auth/register-with-invite or /api/v1/invitations/accept
3) Determine why it redirects to /login:
Common causes:
A) Route guard incorrectly requires auth for invite route (should be public)
B) Client router doesn’t recognize route in production build (Railway) and falls back to /login
C) API call to validate token fails due to cookie/CORS credentials assumption
D) Token lookup uses tenant context middleware requiring effectiveTenantId (should not)
E) AppPublicUrl / redirect URL mismatch causing wrong link (http vs https)

Fix requirements:
A) Public route allowlist
- Ensure invite acceptance page route is PUBLIC:
  - Client route renders without being logged in
  - Server endpoints used to validate/accept invite do NOT require auth middleware
- Update route guards to allow:
  - /auth/invite
  - /auth/reset-password
  - /auth/forgot-password
  - /auth/change-password (if mustChange flow requires)
without redirecting to /login.

B) Token validation endpoint
- Add (or confirm) a public endpoint:
  - GET /api/v1/public/invites/validate?token=...
  Returns safe preview:
  { ok: true, emailMasked, tenantName, role, expiresAt }
- Add (or confirm) accept endpoint:
  - POST /api/v1/public/invites/accept
    Body: { token, password, firstName?, lastName? }
  - Creates/activates user if necessary, sets password hash, marks invite used.
  - Establishes cookie session (same as login), then returns { ok:true }.
NOTE: If you already have endpoints, reuse them; add-only if missing.
Do NOT change existing response shapes—only add endpoints if required.

C) Client UX
- Create/repair InviteAcceptancePage:
  - Reads token from URL
  - Calls validate endpoint and displays:
    - “You’ve been invited to <TenantName> as <Role>”
  - Password fields + submit
  - On success: redirect to correct landing route (tenant or super if applicable)
- If token invalid/expired: show friendly message + requestId + “Contact admin”.

D) Railway correctness
- Ensure the invite URL uses APP_PUBLIC_URL https origin
- Ensure cookie settings allow session establishment after accept:
  - Secure cookies in prod
  - SameSite=Lax
  - trust proxy enabled
- Ensure redirects are correct for SPA routes (Railway) and do not 404.

E) Tests (mandatory)
1) invite_route_is_public_and_does_not_redirect_to_login.test.tsx
2) validate_invite_token_public_endpoint.test.ts
3) accept_invite_sets_password_and_creates_session_cookie.test.ts
4) invite_acceptance_flow_works_without_existing_cookies.test.ts (simulate incognito)

===============================================================================
PART 1 — FORGOT PASSWORD (SAFE, EMAIL OPTIONAL)
===============================================================================
Frontend:
- Login page: “Forgot password?” link
- Form: email
- Always respond with generic message: “If an account exists, you’ll get instructions.”

Backend (add-only if missing):
- POST /api/v1/auth/forgot-password
  - generates a short-lived reset token (e.g., 30–60 minutes)
  - stores hashed token in DB (never plaintext)
  - produces resetUrl: APP_PUBLIC_URL + "/auth/reset-password?token=..."
  - If Mailgun configured: send resetUrl via email
  - If Mailgun NOT configured: still create token and return { ok: true } (preserve existing behavior if present)
  - Audit: password_reset_requested

- POST /api/v1/auth/reset-password
  Body: { token, newPassword }
  - validates token, expiry, not used
  - sets password hash
  - marks token used
  - clears mustChangePasswordOnNextLogin
  - Audit: password_reset_completed

Security:
- rate limit forgot/reset endpoints
- do not reveal whether email exists
- show requestId on errors via X-Request-Id header (client reads header)

DB (additive if needed):
- password_reset_tokens:
  id, userId, tokenHash, expiresAt, usedAt, createdAt, createdByUserId nullable

===============================================================================
PART 2 — SUPER ADMIN: SET INITIAL PASSWORD + RESET/UPDATE TENANT USER PASSWORD
===============================================================================
UI (Super Admin Tenant Drawer):
- Onboarding Wizard: “Tenant Admin Setup”
  - firstName, lastName, email, role=TenantAdmin
  - options:
    [ ] Create user as Active immediately (no invite required)
    [ ] Set initial password now (optional)
    [ ] Generate password reset link (recommended)
    [ ] Send invite email (optional if Mailgun configured)
  - User row shows actions: Manage User, Copy Invite Link, Send/Resend Invite

User Drawer (Super Admin):
- Overview: activate/deactivate, role, profile
- Invitation:
  - view/copy invite link, status, expires, resend/regenerate
- Security:
  - generate password reset link (copy + optional send)
  - optional set temp password + force change on next login

Backend (add-only endpoints if missing):
- POST /api/v1/super/tenants/:tenantId/users
- PATCH /api/v1/super/tenants/:tenantId/users/:userId
- POST /api/v1/super/tenants/:tenantId/users/:userId/password-reset-link
- POST /api/v1/super/tenants/:tenantId/users/:userId/set-password (optional; mustChange true)
- GET /api/v1/super/tenants/:tenantId/users/:userId/invite
- POST /api/v1/super/tenants/:tenantId/users/:userId/invite/send
- POST /api/v1/super/tenants/:tenantId/users/:userId/invite/regenerate

===============================================================================
PART 3 — SUPER ADMIN: TENANT LIFECYCLE CONTROLS
===============================================================================
Statuses:
- ACTIVE, SUSPENDED, ARCHIVED, DELETED (soft-delete preferred)

UI (Super Admin Tenant Drawer):
- Lifecycle tab:
  - actions with confirm phrase:
    - Activate, Suspend, Archive, Delete
  - show status badge + timestamps

Backend:
- PATCH /api/v1/super/tenants/:tenantId/status
  Body: { status: ... }
- Enforce:
  - SUSPENDED/DELETED blocks tenant access
  - ARCHIVED blocks writes, allows reads
Super routes unaffected.

DB:
- Use existing status field if present; else add tenants.status default ACTIVE (additive)
- optional timestamps archivedAt/deletedAt additive

===============================================================================
PART 4 — RAILWAY OPTIMIZATION + RELIABILITY
===============================================================================
- trust proxy enabled
- secure cookies in production
- SameSite=Lax
- Ensure SPA routes (/auth/invite, /auth/reset-password) are correctly served and not redirected away.
- Always provide X-Request-Id and show it in UI on failures.

===============================================================================
TESTS (MANDATORY MINIMUM)
===============================================================================
Invite flow:
1) invite_route_is_public_and_does_not_redirect_to_login.test.tsx
2) validate_invite_token_public_endpoint.test.ts
3) accept_invite_sets_password_and_creates_session_cookie.test.ts
4) invite_acceptance_flow_works_without_existing_cookies.test.ts

Auth:
5) forgot_password_creates_token_and_generic_response.test.ts
6) reset_password_consumes_token_and_sets_hash.test.ts
7) reset_token_cannot_be_reused.test.ts

Super admin user provisioning:
8) super_can_create_tenant_admin_active_with_password.test.ts (if set-password enabled)
9) super_can_generate_reset_link_for_tenant_user.test.ts

Tenant lifecycle:
10) suspend_blocks_tenant_access.test.ts
11) archive_blocks_writes_allows_reads.test.ts
12) delete_blocks_all_access_soft_delete.test.ts

Docs:
- Update /docs/AUTHENTICATION.md (invite accept + reset)
- Update /docs/DEPLOYMENT_RAILWAY.md (SPA routes + cookies + APP_PUBLIC_URL)
- Update /docs/SUPER_ADMIN_GUIDE.md (user provisioning + tenant lifecycle)

===============================================================================
ACCEPTANCE CRITERIA
===============================================================================
- Invite links work in incognito:
  - show invite acceptance page
  - allow password setup
  - accept invite and log in via cookie session
  - land in correct tenant interface
- Super Admin can provision tenant admins with:
  - activation without invite
  - invite link send/resend
  - password reset link
  - optional temp password with must-change
- Super Admin can activate/suspend/archive/delete tenants with enforced behavior.
- Works on Railway; requestId is shown on failures; tests pass.
